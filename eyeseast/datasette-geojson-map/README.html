<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">datasette-geojson-map</h1><a id="user-content-datasette-geojson-map" class="anchor" aria-label="Permalink: datasette-geojson-map" href="#datasette-geojson-map"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://pypi.org/project/datasette-geojson-map/" rel="nofollow"><img src="https://img.shields.io/pypi/v/datasette-geojson-map.svg" alt="PyPI" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/f9ed3dd29f6c765e5ed4f479d0753ab1839e218e799eb02cb4358ce756ab41f7/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f6461746173657474652d67656f6a736f6e2d6d61702e737667"></a>
<a href="https://github.com/eyeseast/datasette-geojson-map/releases"><img src="https://img.shields.io/github/v/release/eyeseast/datasette-geojson-map?include_prereleases&label=changelog" alt="Changelog" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/dc0e4530df50c849f66381a73ce56a248a7cc79ba187c23e397074502bcf8a50/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f762f72656c656173652f65796573656173742f6461746173657474652d67656f6a736f6e2d6d61703f696e636c7564655f70726572656c6561736573266c6162656c3d6368616e67656c6f67"></a>
<a href="https://github.com/eyeseast/datasette-geojson-map/actions?query=workflow%3ATest"><img src="https://github.com/eyeseast/datasette-geojson-map/workflows/Test/badge.svg" alt="Tests" style="max-width: 100%;"></a>
<a href="https://github.com/eyeseast/datasette-geojson-map/blob/main/LICENSE"><img src="https://img.shields.io/badge/license-Apache%202.0-blue.svg" alt="License" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/c355f200ea90fddaa407b6eaab303663a669248ea3ca7b1fcf77dbe04ff5f48c/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d417061636865253230322e302d626c75652e737667"></a></p>
<p dir="auto">Render a map for any query with a geometry column</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Installation</h2><a id="user-content-installation" class="anchor" aria-label="Permalink: Installation" href="#installation"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Install this plugin in the same environment as Datasette.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ datasette install datasette-geojson-map"><pre class="notranslate"><code>$ datasette install datasette-geojson-map
</code></pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Start by loading a GIS file.</p>
<p dir="auto">For example, you might use <a href="https://pypi.org/project/geojson-to-sqlite/" rel="nofollow">geojson-to-sqlite</a> or <a href="https://pypi.org/project/shapefile-to-sqlite/" rel="nofollow">shapefile-to-sqlite</a> to load <a href="https://bostonopendata-boston.opendata.arcgis.com/datasets/3525b0ee6e6b427f9aab5d0a1d0a1a28_0/explore" rel="nofollow">neighborhood boundaries</a> into a SQLite database.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="wget -O neighborhoods.geojson https://opendata.arcgis.com/datasets/3525b0ee6e6b427f9aab5d0a1d0a1a28_0.geojson
geojson-to-sqlite boston.db neighborhoods neighborhoods.geojson"><pre>wget -O neighborhoods.geojson https://opendata.arcgis.com/datasets/3525b0ee6e6b427f9aab5d0a1d0a1a28_0.geojson
geojson-to-sqlite boston.db neighborhoods neighborhoods.geojson</pre></div>
<p dir="auto">(The command above uses Spatialite, but that's not required.)</p>
<p dir="auto">Start up <code>datasette</code> and navigate to the <code>neighborhoods</code> table.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="datasette serve boston.db

# in another terminal tab
open http://localhost:8001/boston/neighborhoods"><pre>datasette serve boston.db

<span class="pl-c"><span class="pl-c">#</span> in another terminal tab</span>
open http://localhost:8001/boston/neighborhoods</pre></div>
<p dir="auto">You should see a map centered on Boston with each neighborhood outlined. Clicking a boundary will bring up a popup with details on that feature.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://raw.githubusercontent.com/eyeseast/datasette-geojson-map/main/img/boston-neighborhoods-map.png"><img src="https://raw.githubusercontent.com/eyeseast/datasette-geojson-map/main/img/boston-neighborhoods-map.png" alt="Boston neighbhorhoods map" style="max-width: 100%;"></a></p>
<p dir="auto">This plugin relies on (and will install) <a href="https://github.com/eyeseast/datasette-geojson">datasette-geojson</a>. Any query that includes a <code>geometry</code> column will produce a map of the results. This also includes single row views.</p>
<p dir="auto">Run the included <code>demo</code> project to see it live.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Configuration</h2><a id="user-content-configuration" class="anchor" aria-label="Permalink: Configuration" href="#configuration"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This project uses the same map configuration as <a href="https://github.com/simonw/datasette-cluster-map">datasette-cluster-map</a>. Here's how you would use <a href="http://maps.stamen.com/terrain/#12/37.7706/-122.3782" rel="nofollow">Stamen's terrain tiles</a>:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="plugins:
  datasette-geojson-map:
    tile_layer: https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}
    tile_layer_options:
      attribution: >-
        Map tiles by <a href="http://stamen.com">Stamen Design</a>, 
        under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. 
        Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, 
        under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.
      subdomains: abcd
      minZoom: 1
      maxZoom: 16
      ext: jpg"><pre><span class="pl-ent">plugins</span>:
  <span class="pl-ent">datasette-geojson-map</span>:
    <span class="pl-ent">tile_layer</span>: <span class="pl-s">https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}</span>
    <span class="pl-ent">tile_layer_options</span>:
      <span class="pl-ent">attribution</span>: <span class="pl-s">>-</span>
<span class="pl-s">        Map tiles by <a href="http://stamen.com">Stamen Design</a>, </span>
<span class="pl-s">        under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. </span>
<span class="pl-s">        Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, </span>
<span class="pl-s">        under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.</span>
<span class="pl-s"></span>      <span class="pl-ent">subdomains</span>: <span class="pl-s">abcd</span>
      <span class="pl-ent">minZoom</span>: <span class="pl-c1">1</span>
      <span class="pl-ent">maxZoom</span>: <span class="pl-c1">16</span>
      <span class="pl-ent">ext</span>: <span class="pl-s">jpg</span></pre></div>
<p dir="auto">Options:</p>
<ul dir="auto">
<li><code>tile_layer</code>: Use a URL template that can be passed to a <a href="https://leafletjs.com/reference-1.7.1.html#tilelayer" rel="nofollow">Leaflet Tilelayer</a></li>
<li><code>tile_layer_options</code>: All options will be passed to the tile layer. See <a href="https://leafletjs.com/reference-1.7.1.html#tilelayer" rel="nofollow">Leaflet documentation</a> for more on possible values here.</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Styling map features</h2><a id="user-content-styling-map-features" class="anchor" aria-label="Permalink: Styling map features" href="#styling-map-features"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Map features can be styled using the <a href="https://github.com/mapbox/simplestyle-spec">simplestyle-spec</a>. This requires setting specific fields on returned rows. Here's an example:</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="SELECT Name, geometry, "#ff0000" as fill, "#0000ff" as stroke, 0.2 as stroke-width,  from neighborhoods"><pre><span class="pl-k">SELECT</span> Name, geometry, <span class="pl-s"><span class="pl-pds">"</span>#ff0000<span class="pl-pds">"</span></span> <span class="pl-k">as</span> fill, <span class="pl-s"><span class="pl-pds">"</span>#0000ff<span class="pl-pds">"</span></span> <span class="pl-k">as</span> stroke, <span class="pl-c1">0</span>.<span class="pl-c1">2</span> <span class="pl-k">as</span> stroke<span class="pl-k">-</span>width,  <span class="pl-k">from</span> neighborhoods</pre></div>
<p dir="auto">That will render a neighborhood map where each polygon is filled in red, outlined in blue and lines are 0.2 pixels wide.</p>
<p dir="auto">A more useful approach would use the <code>CASE</code> statement to color features based on data:</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="SELECT
  Name,
  geometry,
  CASE
    Name
    WHEN "Roslindale" THEN "#ff0000"
    WHEN "Dorchester" THEN "#0000ff"
    ELSE "#dddddd"
  END fill
FROM
  neighborhoods"><pre><span class="pl-k">SELECT</span>
  Name,
  geometry,
  CASE
    Name
    WHEN <span class="pl-s"><span class="pl-pds">"</span>Roslindale<span class="pl-pds">"</span></span> THEN <span class="pl-s"><span class="pl-pds">"</span>#ff0000<span class="pl-pds">"</span></span>
    WHEN <span class="pl-s"><span class="pl-pds">"</span>Dorchester<span class="pl-pds">"</span></span> THEN <span class="pl-s"><span class="pl-pds">"</span>#0000ff<span class="pl-pds">"</span></span>
    ELSE <span class="pl-s"><span class="pl-pds">"</span>#dddddd<span class="pl-pds">"</span></span>
  END fill
<span class="pl-k">FROM</span>
  neighborhoods</pre></div>
<p dir="auto">This will fill Roslindale in red, Dorchester in blue and all other neighborhoods in gray.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Development</h2><a id="user-content-development" class="anchor" aria-label="Permalink: Development" href="#development"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To set up this plugin locally, first checkout the code. Then create a new virtual environment:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="cd datasette-geojson-map
python3 -mvenv venv
source venv/bin/activate"><pre class="notranslate"><code>cd datasette-geojson-map
python3 -mvenv venv
source venv/bin/activate
</code></pre></div>
<p dir="auto">Or if you are using <code>pipenv</code>:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="pipenv shell"><pre class="notranslate"><code>pipenv shell
</code></pre></div>
<p dir="auto">Now install the dependencies and test dependencies:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="pip install -e '.[test]'"><pre class="notranslate"><code>pip install -e '.[test]'
</code></pre></div>
<p dir="auto">To run the tests:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="pytest"><pre class="notranslate"><code>pytest
</code></pre></div>
</article></div>