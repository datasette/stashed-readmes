<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">datasette-permissions-sql</h1><a id="user-content-datasette-permissions-sql" class="anchor" aria-label="Permalink: datasette-permissions-sql" href="#datasette-permissions-sql"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://pypi.org/project/datasette-permissions-sql/" rel="nofollow"><img src="https://img.shields.io/pypi/v/datasette-permissions-sql.svg" alt="PyPI" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/9d0981123a595dd6c3b361fc282f6958f2ba6c6a7f426f5894485eca2c38dcff/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f6461746173657474652d7065726d697373696f6e732d73716c2e737667"></a>
<a href="https://circleci.com/gh/simonw/datasette-permissions-sql" rel="nofollow"><img src="https://circleci.com/gh/simonw/datasette-permissions-sql.svg?style=svg" alt="CircleCI" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/80a68132c1ce2f25d8feac63c39f0f5793f04d07492bf7e8dd494ce09150e179/68747470733a2f2f636972636c6563692e636f6d2f67682f73696d6f6e772f6461746173657474652d7065726d697373696f6e732d73716c2e7376673f7374796c653d737667"></a>
<a href="https://github.com/simonw/datasette-permissions-sql/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-Apache%202.0-blue.svg" alt="License" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/c355f200ea90fddaa407b6eaab303663a669248ea3ca7b1fcf77dbe04ff5f48c/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d417061636865253230322e302d626c75652e737667"></a></p>
<p dir="auto">Datasette plugin for configuring permission checks using SQL queries</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Installation</h2><a id="user-content-installation" class="anchor" aria-label="Permalink: Installation" href="#installation"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Install this plugin in the same environment as Datasette.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ pip install datasette-permissions-sql"><pre class="notranslate"><code>$ pip install datasette-permissions-sql
</code></pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">First, read up on how Datasette's <a href="https://datasette.readthedocs.io/en/latest/authentication.html" rel="nofollow">authentication and permissions system</a> works.</p>
<p dir="auto">This plugin lets you define rules containing SQL queries that are executed to see if the currently authenticated actor has permission to perform certain actions.</p>
<p dir="auto">Consider a canned query which authenticated users should only be able to execute if a row in the <code>users</code> table says that they are a member of staff.</p>
<p dir="auto">That <code>users</code> table in the <code>mydatabase.db</code> database could look like this:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>id</th>
<th>username</th>
<th>is_staff</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>cleopaws</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>simon</td>
<td>1</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Authenticated users have an <code>actor</code> that looks like this:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "id": 2,
    "username": "simon"
}"><pre>{
    <span class="pl-ent">"id"</span>: <span class="pl-c1">2</span>,
    <span class="pl-ent">"username"</span>: <span class="pl-s"><span class="pl-pds">"</span>simon<span class="pl-pds">"</span></span>
}</pre></div>
<p dir="auto">To configure the canned query to only be executable by staff users, add the following to your <code>metadata.json</code>:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "plugins": {
        "datasette-permissions-sql": [
            {
                "action": "view-query",
                "resource": ["mydatabase", "promote_to_staff"],
                "sql": "SELECT * FROM users WHERE is_staff = 1 AND id = :actor_id"
            }
        ]
    },
    "databases": {
        "mydatabase": {
            "queries": {
                "promote_to_staff": {
                    "sql": "UPDATE users SET is is_staff=1 WHERE id=:id",
                    "write": true
                }
            }
        }
    }
}"><pre>{
    <span class="pl-ent">"plugins"</span>: {
        <span class="pl-ent">"datasette-permissions-sql"</span>: [
            {
                <span class="pl-ent">"action"</span>: <span class="pl-s"><span class="pl-pds">"</span>view-query<span class="pl-pds">"</span></span>,
                <span class="pl-ent">"resource"</span>: [<span class="pl-s"><span class="pl-pds">"</span>mydatabase<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>promote_to_staff<span class="pl-pds">"</span></span>],
                <span class="pl-ent">"sql"</span>: <span class="pl-s"><span class="pl-pds">"</span>SELECT * FROM users WHERE is_staff = 1 AND id = :actor_id<span class="pl-pds">"</span></span>
            }
        ]
    },
    <span class="pl-ent">"databases"</span>: {
        <span class="pl-ent">"mydatabase"</span>: {
            <span class="pl-ent">"queries"</span>: {
                <span class="pl-ent">"promote_to_staff"</span>: {
                    <span class="pl-ent">"sql"</span>: <span class="pl-s"><span class="pl-pds">"</span>UPDATE users SET is is_staff=1 WHERE id=:id<span class="pl-pds">"</span></span>,
                    <span class="pl-ent">"write"</span>: <span class="pl-c1">true</span>
                }
            }
        }
    }
}</pre></div>
<p dir="auto">The <code>"datasette-permissions-sql"</code> key is a list of rules. Each of those rules has the following shape:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "action": "name-of-action",
    "resource": ["resource identifier to run this on"],
    "sql": "SQL query to execute",
    "database": "mydatabase"
}"><pre>{
    <span class="pl-ent">"action"</span>: <span class="pl-s"><span class="pl-pds">"</span>name-of-action<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"resource"</span>: [<span class="pl-s"><span class="pl-pds">"</span>resource identifier to run this on<span class="pl-pds">"</span></span>],
    <span class="pl-ent">"sql"</span>: <span class="pl-s"><span class="pl-pds">"</span>SQL query to execute<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"database"</span>: <span class="pl-s"><span class="pl-pds">"</span>mydatabase<span class="pl-pds">"</span></span>
}</pre></div>
<p dir="auto">Both <code>"action"</code> and <code>"resource"</code> are optional. If present, the SQL query will only be executed on permission checks that match the action and, if present, the resource indicators.</p>
<p dir="auto"><code>"database"</code> is also optional: it specifies the named database that the query should be executed against. If it is not present the first connected database will be used.</p>
<p dir="auto">The Datasette documentation includes a <a href="https://datasette.readthedocs.io/en/stable/authentication.html#built-in-permissions" rel="nofollow">list of built-in permissions</a> that you might want to use here.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">The SQL query</h3><a id="user-content-the-sql-query" class="anchor" aria-label="Permalink: The SQL query" href="#the-sql-query"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If the SQL query returns any rows the action will be allowed. If it returns no rows, the plugin hook will return <code>False</code> and deny access to that action.</p>
<p dir="auto">The SQL query is called with a number of named parameters. You can use any of these as part of the query.</p>
<p dir="auto">The list of parameters is as follows:</p>
<ul dir="auto">
<li><code>action</code> - the action, e.g. <code>"view-database"</code></li>
<li><code>resource_1</code> - the first component of the resource, if one was passed</li>
<li><code>resource_2</code> - the second component of the resource, if available</li>
<li><code>actor_*</code> - a parameter for every key on the actor. Usually <code>actor_id</code> is present.</li>
</ul>
<p dir="auto">If any rows are returned, the permission check passes. If no rows are returned the check fails.</p>
<p dir="auto">Another example table, this time granting explicit access to individual tables. Consider a table called <code>table_access</code> that looks like this:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>user_id</th>
<th>database</th>
<th>table</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>mydb</td>
<td>dogs</td>
</tr>
<tr>
<td>2</td>
<td>mydb</td>
<td>dogs</td>
</tr>
<tr>
<td>1</td>
<td>mydb</td>
<td>cats</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">The following SQL query would grant access to the <code>dogs</code> ttable in the <code>mydb.db</code> database to users 1 and 2 - but would forbid access for user 2 to the <code>cats</code> table:</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="SELECT
    *
FROM
    table_access
WHERE
    user_id = :actor_id
    AND "database" = :resource_1
    AND "table" = :resource_2"><pre><span class="pl-k">SELECT</span>
    <span class="pl-k">*</span>
<span class="pl-k">FROM</span>
    table_access
<span class="pl-k">WHERE</span>
    user_id <span class="pl-k">=</span> :actor_id
    <span class="pl-k">AND</span> <span class="pl-s"><span class="pl-pds">"</span>database<span class="pl-pds">"</span></span> <span class="pl-k">=</span> :resource_1
    <span class="pl-k">AND</span> <span class="pl-s"><span class="pl-pds">"</span>table<span class="pl-pds">"</span></span> <span class="pl-k">=</span> :resource_2</pre></div>
<p dir="auto">In a <code>metadata.yaml</code> configuration file that would look like this:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="databases:
  mydb:
    allow_sql: {}
plugins:
  datasette-permissions-sql:
  - action: view-table
    sql: |-
      SELECT
        *
      FROM
        table_access
      WHERE
        user_id = :actor_id
        AND "database" = :resource_1
        AND "table" = :resource_2"><pre><span class="pl-ent">databases</span>:
  <span class="pl-ent">mydb</span>:
    <span class="pl-ent">allow_sql</span>: <span class="pl-s">{}</span>
<span class="pl-ent">plugins</span>:
  <span class="pl-ent">datasette-permissions-sql</span>:
  - <span class="pl-ent">action</span>: <span class="pl-s">view-table</span>
    <span class="pl-ent">sql</span>: <span class="pl-s">|-</span>
<span class="pl-s">      SELECT</span>
<span class="pl-s">        *</span>
<span class="pl-s">      FROM</span>
<span class="pl-s">        table_access</span>
<span class="pl-s">      WHERE</span>
<span class="pl-s">        user_id = :actor_id</span>
<span class="pl-s">        AND "database" = :resource_1</span>
<span class="pl-s">        AND "table" = :resource_2</span></pre></div>
<p dir="auto">We're using <code>allow_sql: {}</code> here to disable arbitrary SQL queries. This prevents users from running <code>select * from cats</code> directly to work around the permissions limits.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Fallback mode</h3><a id="user-content-fallback-mode" class="anchor" aria-label="Permalink: Fallback mode" href="#fallback-mode"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The default behaviour of this plugin is to take full control of specified permissions. The SQL query will directly control if the user is allowed or denied access to the permission.</p>
<p dir="auto">This means that the default policy for each permission (which in Datasette core is "allow" for <code>view-database</code> and friends) will be ignored. It also means that any other <code>permission_allowed</code> plugins will not get their turn once this plugin has executed.</p>
<p dir="auto">You can change this on a per-rule basis using <code>"fallback": true</code>:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "action": "view-table",
    "resource": ["mydatabase", "mytable"],
    "sql": "select * from admins where user_id = :actor_id",
    "fallback": true
}"><pre>{
    <span class="pl-ent">"action"</span>: <span class="pl-s"><span class="pl-pds">"</span>view-table<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"resource"</span>: [<span class="pl-s"><span class="pl-pds">"</span>mydatabase<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>mytable<span class="pl-pds">"</span></span>],
    <span class="pl-ent">"sql"</span>: <span class="pl-s"><span class="pl-pds">"</span>select * from admins where user_id = :actor_id<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"fallback"</span>: <span class="pl-c1">true</span>
}</pre></div>
<p dir="auto">When running in fallback mode, a query result returning no rows will cause the plugin hook to return <code>None</code> - which means "I have no opinion on this permission, fall back to other plugins or the default".</p>
<p dir="auto">In this mode you can still return <code>False</code> (for "deny access") by returning a single row with a single value of <code>-1</code>. For example:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "action": "view-table",
    "resource": ["mydatabase", "mytable"],
    "sql": "select -1 from banned where user_id = :actor_id",
    "fallback": true
}"><pre>{
    <span class="pl-ent">"action"</span>: <span class="pl-s"><span class="pl-pds">"</span>view-table<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"resource"</span>: [<span class="pl-s"><span class="pl-pds">"</span>mydatabase<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>mytable<span class="pl-pds">"</span></span>],
    <span class="pl-ent">"sql"</span>: <span class="pl-s"><span class="pl-pds">"</span>select -1 from banned where user_id = :actor_id<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"fallback"</span>: <span class="pl-c1">true</span>
}</pre></div>
</article></div>