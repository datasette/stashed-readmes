<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">datasette-faiss</h1><a id="user-content-datasette-faiss" class="anchor" aria-label="Permalink: datasette-faiss" href="#datasette-faiss"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://pypi.org/project/datasette-faiss/" rel="nofollow"><img src="https://img.shields.io/pypi/v/datasette-faiss.svg" alt="PyPI" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/d3c54d64c62cac2f841065f27ae3add463120bc568f60d8a8b55f551befd8a94/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f6461746173657474652d66616973732e737667"></a>
<a href="https://github.com/simonw/datasette-faiss/releases"><img src="https://img.shields.io/github/v/release/simonw/datasette-faiss?include_prereleases&label=changelog" alt="Changelog" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/3570cd1979f075f4f1104a2e7a29e9a6fb4b91ac51f9a2be28c2645b0fce4301/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f762f72656c656173652f73696d6f6e772f6461746173657474652d66616973733f696e636c7564655f70726572656c6561736573266c6162656c3d6368616e67656c6f67"></a>
<a href="https://github.com/simonw/datasette-faiss/actions?query=workflow%3ATest"><img src="https://github.com/simonw/datasette-faiss/workflows/Test/badge.svg" alt="Tests" style="max-width: 100%;"></a>
<a href="https://github.com/simonw/datasette-faiss/blob/main/LICENSE"><img src="https://img.shields.io/badge/license-Apache%202.0-blue.svg" alt="License" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/c355f200ea90fddaa407b6eaab303663a669248ea3ca7b1fcf77dbe04ff5f48c/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d417061636865253230322e302d626c75652e737667"></a></p>
<p dir="auto">Maintain a <a href="https://github.com/facebookresearch/faiss">FAISS index</a> for specified Datasette tables</p>
<p dir="auto">See <a href="https://simonwillison.net/2023/Jan/13/semantic-search-answers/" rel="nofollow">Semantic search answers: Q&A against documentation with GPT3 + OpenAI embeddings</a> for background on this project.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Installation</h2><a id="user-content-installation" class="anchor" aria-label="Permalink: Installation" href="#installation"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Install this plugin in the same environment as Datasette.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="datasette install datasette-faiss"><pre>datasette install datasette-faiss</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This plugin creates in-memory FAISS indexes for specified tables on startup, using an <code>IndexFlatL2</code> <a href="https://github.com/facebookresearch/faiss/wiki/Faiss-indexes">FAISS index type</a>.</p>
<p dir="auto">If the tables are modified after the server has started the indexes will not (yet) pick up those changes.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Configuration</h3><a id="user-content-configuration" class="anchor" aria-label="Permalink: Configuration" href="#configuration"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The tables to be indexed must have <code>id</code> and <code>embedding</code> columns. The <code>embedding</code> column must be a <code>blob</code> containing embeddings that are arrays of floating point numbers that have been encoded using the following Python function:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="def encode(vector):
    return struct.pack("f" * len(vector), *vector)"><pre><span class="pl-k">def</span> <span class="pl-en">encode</span>(<span class="pl-s1">vector</span>):
    <span class="pl-k">return</span> <span class="pl-s1">struct</span>.<span class="pl-c1">pack</span>(<span class="pl-s">"f"</span> <span class="pl-c1">*</span> <span class="pl-en">len</span>(<span class="pl-s1">vector</span>), <span class="pl-c1">*</span><span class="pl-s1">vector</span>)</pre></div>
<p dir="auto">You can import that function from this package like so:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="from datasette_faiss import encode"><pre><span class="pl-k">from</span> <span class="pl-s1">datasette_faiss</span> <span class="pl-k">import</span> <span class="pl-s1">encode</span></pre></div>
<p dir="auto">You can specify which tables should have indexes created for them by adding this to <code>metadata.json</code>:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "plugins": {
        "datasette-faiss": {
            "tables": [
                ["blog", "embeddings"]
            ]
        }
    }
}"><pre>{
    <span class="pl-ent">"plugins"</span>: {
        <span class="pl-ent">"datasette-faiss"</span>: {
            <span class="pl-ent">"tables"</span>: [
                [<span class="pl-s"><span class="pl-pds">"</span>blog<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>embeddings<span class="pl-pds">"</span></span>]
            ]
        }
    }
}</pre></div>
<p dir="auto">Each table is an array listing the database name and the table name.</p>
<p dir="auto">If you are using <code>metadata.yml</code> the configuration should look like this:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="plugins:
  datasette-faiss:
    tables:
    - ["blog", "embeddings"]"><pre><span class="pl-ent">plugins</span>:
  <span class="pl-ent">datasette-faiss</span>:
    <span class="pl-ent">tables</span>:
    - <span class="pl-s">["blog", "embeddings"]</span></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">SQL functions</h3><a id="user-content-sql-functions" class="anchor" aria-label="Permalink: SQL functions" href="#sql-functions"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The plugin makes four new SQL functions available within Datasette:</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">faiss_search(database, table, embedding, k)</h4><a id="user-content-faiss_searchdatabase-table-embedding-k" class="anchor" aria-label="Permalink: faiss_search(database, table, embedding, k)" href="#faiss_searchdatabase-table-embedding-k"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Returns the <code>k</code> nearest neighbors to the <code>embedding</code> found in the specified database and table. For example:</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="select faiss_search('blog', 'embeddings', (select embedding from embeddings where id = 3), 5)"><pre><span class="pl-k">select</span> faiss_search(<span class="pl-s"><span class="pl-pds">'</span>blog<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>embeddings<span class="pl-pds">'</span></span>, (<span class="pl-k">select</span> embedding <span class="pl-k">from</span> embeddings <span class="pl-k">where</span> id <span class="pl-k">=</span> <span class="pl-c1">3</span>), <span class="pl-c1">5</span>)</pre></div>
<p dir="auto">This will return a JSON array of the five IDs of the records in the <code>embeddings</code> table in the <code>blog</code> database that are closest to the specified embedding. The returned value looks like this:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="["1", "1249", "1011", "5", "10"]"><pre>[<span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>1249<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>1011<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>5<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>10<span class="pl-pds">"</span></span>]</pre></div>
<p dir="auto">You can use the SQLite <code>json_each()</code> function to turn that into a table-like sequence that you can join against.</p>
<p dir="auto">Here's an example query that does that:</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="with related as (
  select value from json_each(
    faiss_search(
      'blog',
      'embeddings',
      (select embedding from embeddings limit 1),
      5
    )
  )
)
select * from blog_entry, related
where id = value"><pre>with related <span class="pl-k">as</span> (
  <span class="pl-k">select</span> value <span class="pl-k">from</span> json_each(
    faiss_search(
      <span class="pl-s"><span class="pl-pds">'</span>blog<span class="pl-pds">'</span></span>,
      <span class="pl-s"><span class="pl-pds">'</span>embeddings<span class="pl-pds">'</span></span>,
      (<span class="pl-k">select</span> embedding <span class="pl-k">from</span> embeddings <span class="pl-k">limit</span> <span class="pl-c1">1</span>),
      <span class="pl-c1">5</span>
    )
  )
)
<span class="pl-k">select</span> <span class="pl-k">*</span> <span class="pl-k">from</span> blog_entry, related
<span class="pl-k">where</span> id <span class="pl-k">=</span> value</pre></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">faiss_search_with_scores(database, table, embedding, k)</h4><a id="user-content-faiss_search_with_scoresdatabase-table-embedding-k" class="anchor" aria-label="Permalink: faiss_search_with_scores(database, table, embedding, k)" href="#faiss_search_with_scoresdatabase-table-embedding-k"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Takes the same arguments as above, but the return value is a JSON array of pairs, each with an ID and a score - something like this:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="[
    ["1", 0.0],
    ["1249", 0.21042244136333466],
    ["1011", 0.29391372203826904],
    ["5", 0.29505783319473267],
    ["10", 0.31554925441741943]
]"><pre>[
    [<span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>, <span class="pl-c1">0.0</span>],
    [<span class="pl-s"><span class="pl-pds">"</span>1249<span class="pl-pds">"</span></span>, <span class="pl-c1">0.21042244136333466</span>],
    [<span class="pl-s"><span class="pl-pds">"</span>1011<span class="pl-pds">"</span></span>, <span class="pl-c1">0.29391372203826904</span>],
    [<span class="pl-s"><span class="pl-pds">"</span>5<span class="pl-pds">"</span></span>, <span class="pl-c1">0.29505783319473267</span>],
    [<span class="pl-s"><span class="pl-pds">"</span>10<span class="pl-pds">"</span></span>, <span class="pl-c1">0.31554925441741943</span>]
]</pre></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">faiss_encode(json_vector)</h4><a id="user-content-faiss_encodejson_vector" class="anchor" aria-label="Permalink: faiss_encode(json_vector)" href="#faiss_encodejson_vector"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Given a JSON array of floats, returns the binary embedding blob that can be used with the other functions:</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="select faiss_encode('[2.4, 4.1, 1.8]')
-- Returns a 12 byte blob
select hex(faiss_encode('[2.4, 4.1, 1.8]'))
-- Returns 9A991940333383406666E63F"><pre><span class="pl-k">select</span> faiss_encode(<span class="pl-s"><span class="pl-pds">'</span>[2.4, 4.1, 1.8]<span class="pl-pds">'</span></span>)
<span class="pl-c"><span class="pl-c">--</span> Returns a 12 byte blob</span>
<span class="pl-k">select</span> hex(faiss_encode(<span class="pl-s"><span class="pl-pds">'</span>[2.4, 4.1, 1.8]<span class="pl-pds">'</span></span>))
<span class="pl-c"><span class="pl-c">--</span> Returns 9A991940333383406666E63F</span></pre></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">faiss_decode(vector_blob)</h4><a id="user-content-faiss_decodevector_blob" class="anchor" aria-label="Permalink: faiss_decode(vector_blob)" href="#faiss_decodevector_blob"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The opposite of <code>faiss_encode()</code>.</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="select faiss_decode(X'9A991940333383406666E63F')"><pre><span class="pl-k">select</span> faiss_decode(X<span class="pl-s"><span class="pl-pds">'</span>9A991940333383406666E63F<span class="pl-pds">'</span></span>)</pre></div>
<p dir="auto">Returns:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="[2.4000000953674316, 4.099999904632568, 1.7999999523162842]"><pre>[<span class="pl-c1">2.4000000953674316</span>, <span class="pl-c1">4.099999904632568</span>, <span class="pl-c1">1.7999999523162842</span>]</pre></div>
<p dir="auto">Note that floating point arithmetic results in numbers that don't quite round-trip to the exact same expected value.</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">faiss_agg(id, embedding, compare_embedding, k)</h4><a id="user-content-faiss_aggid-embedding-compare_embedding-k" class="anchor" aria-label="Permalink: faiss_agg(id, embedding, compare_embedding, k)" href="#faiss_aggid-embedding-compare_embedding-k"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This aggregate function can be used to find the <code>k</code> nearest neighbors to <code>compare_embedding</code> for each unique value of <code>id</code> in the table. For example:</p>
<div class="highlight highlight-source-sql notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="select faiss_agg(
    id, embedding, (select embedding from embeddings where id = 3), 5
) from embeddings"><pre><span class="pl-k">select</span> faiss_agg(
    id, embedding, (<span class="pl-k">select</span> embedding <span class="pl-k">from</span> embeddings <span class="pl-k">where</span> id <span class="pl-k">=</span> <span class="pl-c1">3</span>), <span class="pl-c1">5</span>
) <span class="pl-k">from</span> embeddings</pre></div>
<p dir="auto">Unlike the <code>faiss_search()</code> function, this does not depend on the per-table index that the plugin creates when it first starts running. Instead, an index is built every time the aggregation function is run.</p>
<p dir="auto">This means that it should only be used on smaller sets of values - once you get above 10,000 or so the performance from this function is likely to become prohibitively expensive.</p>
<p dir="auto">The function returns a JSON array of IDs representing the <code>k</code> rows with the closest distance scores, like this:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="[1324, 344, 5562, 553, 2534]"><pre>[<span class="pl-c1">1324</span>, <span class="pl-c1">344</span>, <span class="pl-c1">5562</span>, <span class="pl-c1">553</span>, <span class="pl-c1">2534</span>]</pre></div>
<p dir="auto">You can use the <code>json_each()</code> function to turn that into a table-like sequence that you can join against.</p>
<p dir="auto"><a href="https://datasette.simonwillison.net/simonwillisonblog?sql=with+last_500+as+%28%0D%0A++select%0D%0A++++id%2C%0D%0A++++embedding%0D%0A++from%0D%0A++++blog_entry_embeddings%0D%0A++order+by%0D%0A++++id+desc%0D%0A++limit%0D%0A++++500%0D%0A%29%2C+faiss+as+%28%0D%0A++select%0D%0A++++faiss_agg%28%0D%0A++++++id%2C%0D%0A++++++embedding%2C%0D%0A++++++%28%0D%0A++++++++select%0D%0A++++++++++embedding%0D%0A++++++++from%0D%0A++++++++++blog_entry_embeddings%0D%0A++++++++where%0D%0A++++++++++id+%3D+%3Aid%0D%0A++++++%29%2C%0D%0A++++++10%0D%0A++++%29+as+results%0D%0A++from%0D%0A++++last_500%0D%0A%29%2C%0D%0Aids+as+%28%0D%0A++select%0D%0A++++value+as+id%0D%0A++from%0D%0A++++json_each%28faiss.results%29%2C%0D%0A++++faiss%0D%0A%29%0D%0Aselect%0D%0A++blog_entry.id%2C%0D%0A++blog_entry.title%2C%0D%0A++blog_entry.created%0D%0Afrom%0D%0A++ids%0D%0A++join+blog_entry+on+ids.id+%3D+blog_entry.id&id=8214" rel="nofollow">Try an example fais_agg() query</a>.</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">faiss_agg_with_scores(id, embedding, compare_embedding, k)</h4><a id="user-content-faiss_agg_with_scoresid-embedding-compare_embedding-k" class="anchor" aria-label="Permalink: faiss_agg_with_scores(id, embedding, compare_embedding, k)" href="#faiss_agg_with_scoresid-embedding-compare_embedding-k"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This is similar to the <code>faiss_agg()</code> aggregate function but it returns a list of pairs, each with an ID and the corresponding score - something that looks like this (if <code>k</code> was 2):</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="[[2412, 0.25], [1245, 24.25]]"><pre>[[<span class="pl-c1">2412</span>, <span class="pl-c1">0.25</span>], [<span class="pl-c1">1245</span>, <span class="pl-c1">24.25</span>]]</pre></div>
<p dir="auto"><a href="https://datasette.simonwillison.net/simonwillisonblog?sql=with+last_500+as+%28%0D%0A++select%0D%0A++++id%2C%0D%0A++++embedding%0D%0A++from%0D%0A++++blog_entry_embeddings%0D%0A++order+by%0D%0A++++id+desc%0D%0A++limit%0D%0A++++500%0D%0A%29%2C+ids_and_scores+as+%28%0D%0A++select%0D%0A++++faiss_agg_with_scores%28%0D%0A++++++id%2C%0D%0A++++++embedding%2C%0D%0A++++++%28%0D%0A++++++++select%0D%0A++++++++++embedding%0D%0A++++++++from%0D%0A++++++++++blog_entry_embeddings%0D%0A++++++++where%0D%0A++++++++++id+%3D+%3Aid%0D%0A++++++%29%2C+10%0D%0A++++%29+as+s%0D%0A++from%0D%0A++++last_500%0D%0A%29%2C%0D%0Aresults+as+%28%0D%0A++select%0D%0A++++json_extract%28value%2C+%27%24%5B0%5D%27%29+as+id%2C%0D%0A++++json_extract%28value%2C+%27%24%5B1%5D%27%29+as+score%0D%0A++from%0D%0A++++json_each%28ids_and_scores.s%29%2C%0D%0A++++ids_and_scores%0D%0A%29%0D%0Aselect%0D%0A++results.score%2C%0D%0A++blog_entry.id%2C%0D%0A++blog_entry.title%2C%0D%0A++blog_entry.created%0D%0Afrom%0D%0A++results%0D%0A++join+blog_entry+on+results.id+%3D+blog_entry.id&id=8214" rel="nofollow">Try an example fais_agg_with_scores() query</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Development</h2><a id="user-content-development" class="anchor" aria-label="Permalink: Development" href="#development"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To set up this plugin locally, first checkout the code. Then create a new virtual environment:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cd datasette-faiss
python3 -m venv venv
source venv/bin/activate"><pre><span class="pl-c1">cd</span> datasette-faiss
python3 -m venv venv
<span class="pl-c1">source</span> venv/bin/activate</pre></div>
<p dir="auto">Now install the dependencies and test dependencies:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="pip install -e '.[test]'"><pre>pip install -e <span class="pl-s"><span class="pl-pds">'</span>.[test]<span class="pl-pds">'</span></span></pre></div>
<p dir="auto">To run the tests:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="pytest"><pre>pytest</pre></div>
</article></div>