<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">datasette-auth-existing-cookies</h1><a id="user-content-datasette-auth-existing-cookies" class="anchor" aria-label="Permalink: datasette-auth-existing-cookies" href="#datasette-auth-existing-cookies"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://pypi.org/project/datasette-auth-existing-cookies/" rel="nofollow"><img src="https://img.shields.io/pypi/v/datasette-auth-existing-cookies.svg" alt="PyPI" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/f7d653386c3caaf112dfbf15a6be7783cd3032babb5f3348eada8086b00bd0dd/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f6461746173657474652d617574682d6578697374696e672d636f6f6b6965732e737667"></a>
<a href="https://github.com/simonw/datasette-auth-existing-cookies/releases"><img src="https://img.shields.io/github/v/release/simonw/datasette-auth-existing-cookies?include_prereleases&label=changelog" alt="Changelog" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/34ecbc5806e61da22dfa96fbe8c71dd3622751ecb609f527a79fa6f7e981194f/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f762f72656c656173652f73696d6f6e772f6461746173657474652d617574682d6578697374696e672d636f6f6b6965733f696e636c7564655f70726572656c6561736573266c6162656c3d6368616e67656c6f67"></a>
<a href="https://github.com/simonw/datasette-auth-existing-cookies/actions?query=workflow%3ATest"><img src="https://github.com/simonw/datasette-auth-existing-cookies/workflows/Test/badge.svg" alt="Tests" style="max-width: 100%;"></a>
<a href="https://github.com/simonw/datasette-auth-existing-cookies/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-Apache%202.0-blue.svg" alt="License" style="max-width: 100%;" data-camo-src="https://camo.githubusercontent.com/c355f200ea90fddaa407b6eaab303663a669248ea3ca7b1fcf77dbe04ff5f48c/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d417061636865253230322e302d626c75652e737667"></a></p>
<p dir="auto">Datasette plugin that authenticates users based on existing domain cookies.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">When to use this</h2><a id="user-content-when-to-use-this" class="anchor" aria-label="Permalink: When to use this" href="#when-to-use-this"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This plugin allows you to build custom authentication for Datasette when you are hosting a Datasette instance on the same domain as another, authenticated website.</p>
<p dir="auto">Consider a website on <code>www.example.com</code> which supports user authentication.</p>
<p dir="auto">You could run Datasette on <code>data.example.com</code> in a way that lets it see cookies that were set for the <code>.example.com</code> domain.</p>
<p dir="auto">Using this plugin, you could build an API endpoint at <code>www.example.com/user-for-cookies</code> which returns a JSON object representing the currently signed-in user, based on their cookies.</p>
<p dir="auto">The plugin running on <code>data.example.com</code> will then make the <code>actor</code> available to the rest of Datasette based on the response from that API.</p>
<p dir="auto">Read about <a href="https://docs.datasette.io/en/stable/authentication.html" rel="nofollow">Datasette's authentication and permissions system</a> for more on how actors and permissions work.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Configuration</h2><a id="user-content-configuration" class="anchor" aria-label="Permalink: Configuration" href="#configuration"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This plugin requires some configuration in the Datasette <a href="https://datasette.readthedocs.io/en/stable/plugins.html#plugin-configuration" rel="nofollow">metadata.json file</a>.</p>
<p dir="auto">The following configuration options are supported:</p>
<ul dir="auto">
<li><code>api_url</code>: this is the API endpoint that Datasette should call with the user's cookies in order to identify the logged in user.</li>
<li><code>cookies</code>: optional. A list of cookie names that should be passed through to the API endpoint - if left blank, the default is to send all cookies.</li>
<li><code>ttl</code>: optional. By default Datasette will make a request to the API endpoint for every HTTP request recieved by Datasette itself. A <code>ttl</code> value of 5 will cause Datasette to cache the actor associated with the user's cookies for 5 seconds, reducing that API traffic.</li>
<li><code>headers</code>: an optional list of other headers to forward to the API endpoint as query string parameters.</li>
</ul>
<p dir="auto">Here is an example that uses all four of these settings:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "plugins": {
        "datasette-auth-existing-cookies": {
            "api_url": "http://www.example.com/user-from-cookies",
            "cookies": ["sessionid"],
            "headers": ["host"],
            "ttl": 10
        }
    }
}"><pre>{
    <span class="pl-ent">"plugins"</span>: {
        <span class="pl-ent">"datasette-auth-existing-cookies"</span>: {
            <span class="pl-ent">"api_url"</span>: <span class="pl-s"><span class="pl-pds">"</span>http://www.example.com/user-from-cookies<span class="pl-pds">"</span></span>,
            <span class="pl-ent">"cookies"</span>: [<span class="pl-s"><span class="pl-pds">"</span>sessionid<span class="pl-pds">"</span></span>],
            <span class="pl-ent">"headers"</span>: [<span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span>],
            <span class="pl-ent">"ttl"</span>: <span class="pl-c1">10</span>
        }
    }
}</pre></div>
<p dir="auto">With this configuration any hit to a Datasette hosted at <code>data.example.com</code> will result in the following request being made to the <code>http://www.example.com/user-from-cookies</code> API endpoint:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="GET http://www.example.com/user-from-cookies?host=data.example.com
Cookie: sessionid=abc123"><pre class="notranslate"><code>GET http://www.example.com/user-from-cookies?host=data.example.com
Cookie: sessionid=abc123
</code></pre></div>
<p dir="auto">That API is expected to return a JSON object representing the current user:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
    "id": 1,
    "name": "Barry"
}"><pre>{
    <span class="pl-ent">"id"</span>: <span class="pl-c1">1</span>,
    <span class="pl-ent">"name"</span>: <span class="pl-s"><span class="pl-pds">"</span>Barry<span class="pl-pds">"</span></span>
}</pre></div>
<p dir="auto">Since <code>ttl</code> is set to 10 that actor will be cached for ten seconds against that exact combination of cookies and headers. When that cache expires another hit will be made to the API.</p>
<p dir="auto">When deciding on a TTL value, take into account that users who lose access to the core site - maybe because their session expires, or their account is disabled - will still be able to access the Datasette instance until that cache expires.</p>
</article></div>